<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSN Messenger 2004 - Admin</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Tahoma", "Arial", sans-serif;
        }

        body {
            background: #0066cc;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .admin-container {
            width: 95%;
            height: 95%;
            background-color: #ece9d8;
            border: 2px solid #003399;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .title-bar {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 1px solid #003399;
        }

        .window-controls {
            display: flex;
        }

        .control-btn {
            width: 18px;
            height: 18px;
            margin-left: 5px;
            background-color: #ece9d8;
            border: 1px solid #003399;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .control-btn:hover {
            background-color: #d9d6c5;
        }

        .menu-bar {
            background-color: #ece9d8;
            border-bottom: 1px solid #aca899;
            padding: 3px 5px;
            display: flex;
            font-size: 11px;
        }

        .menu-item {
            margin-right: 15px;
            cursor: pointer;
            padding: 2px 5px;
        }

        .menu-item:hover {
            background-color: #d9d6c5;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .admin-panel {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .admin-section {
            background: white;
            border: 1px solid #aca899;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            color: #003399;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .user-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #aca899;
            padding: 10px;
            background: #f9f9f9;
        }

        .user-item {
            padding: 5px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-danger {
            background: #cc0000;
            color: white;
        }

        .btn-success {
            background: #00cc00;
            color: white;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #aca899;
            border-radius: 3px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #003399;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
        }

        .login-container {
            background-color: #ece9d8;
            border: 2px solid #003399;
            border-radius: 5px;
            padding: 20px;
            width: 320px;
        }

        .login-header {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .login-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #aca899;
            border-radius: 3px;
        }

        .login-btn {
            width: 100%;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .login-btn:hover {
            background: #3d8b40;
        }

        .error-message {
            color: #cc0000;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }

        .admin-only {
            border: 2px solid #ff6600;
            background: #fff8f0;
        }

        .admin-badge {
            background: #ff6600;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .db-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 10px;
        }

        .db-online {
            background: #00cc00;
            color: white;
        }

        .db-offline {
            background: #cc0000;
            color: white;
        }
    </style>
</head>
<body>
    <!-- √âCRAN DE CONNEXION ADMIN -->
    <div class="login-container" id="loginContainer">
        <div class="login-header">MSN Messenger 2004 - Admin</div>
        <div class="error-message" id="firebaseStatus">Chargement de Firebase...</div>
        <input type="text" class="login-input" id="usernameInput" placeholder="Nom d'administrateur">
        <input type="password" class="login-input" id="passwordInput" placeholder="Mot de passe admin">
        <button class="login-btn" id="loginBtn">Connexion Admin</button>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- INTERFACE ADMIN -->
    <div class="admin-container" id="adminContainer" style="display: none;">
        <!-- Barre de titre -->
        <div class="title-bar">
            <div>
                üöÄ MSN Messenger 2004 - Panneau d'Administration
                <span class="db-status db-online" id="dbStatus">Base de donn√©es connect√©e</span>
            </div>
            <div class="window-controls">
                <div class="control-btn" id="refreshBtn">‚Üª</div>
                <div class="control-btn" id="logoutBtn">√ó</div>
            </div>
        </div>

        <!-- Barre de menu -->
        <div class="menu-bar">
            <div class="menu-item">Utilisateurs</div>
            <div class="menu-item">Messages</div>
            <div class="menu-item">Param√®tres</div>
            <div class="menu-item">Syst√®me</div>
            <div class="menu-item">Aide</div>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="admin-panel">
                <!-- Section Utilisateurs Connect√©s -->
                <div class="admin-section">
                    <div class="section-title">
                        üë• Utilisateurs Actuellement Connect√©s
                        <span class="admin-badge" id="onlineCount">0</span>
                    </div>
                    <div class="user-list" id="connectedUsers">
                        <div class="user-item">Chargement des utilisateurs...</div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-danger" id="kickAllBtn">D√©connecter tous les utilisateurs</button>
                    </div>
                </div>

                <!-- Section Gestion des Utilisateurs -->
                <div class="admin-section">
                    <div class="section-title">üë§ Gestion des Utilisateurs</div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="searchUserInput" placeholder="Rechercher un utilisateur...">
                        <button class="btn btn-primary" id="searchUserBtn">Rechercher</button>
                    </div>
                    <div class="user-list" id="allUsers">
                        <!-- Tous les utilisateurs appara√Ætront ici -->
                    </div>
                </div>

                <!-- Section Statistiques -->
                <div class="admin-section">
                    <div class="section-title">üìä Statistiques du Syst√®me</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Utilisateurs total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeChats">0</div>
                            <div class="stat-label">Conversations actives</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="messagesToday">0</div>
                            <div class="stat-label">Messages aujourd'hui</div>
                        </div>
                    </div>
                </div>

                <!-- Section Administration -->
                <div class="admin-section admin-only">
                    <div class="section-title">‚öôÔ∏è Commandes Administrateur</div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="broadcastInput" placeholder="Message de broadcast √† tous les utilisateurs">
                        <button class="btn btn-primary" id="broadcastBtn">Envoyer Broadcast</button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-danger" id="clearChatBtn">Vider tous les chats</button>
                        <button class="btn btn-danger" id="resetSystemBtn">R√©initialiser le syst√®me</button>
                    </div>
                </div>

                <!-- Section Logs -->
                <div class="admin-section">
                    <div class="section-title">üìù Journaux d'Activit√©</div>
                    <div class="user-list" id="activityLogs" style="max-height: 150px;">
                        <div class="user-item">Chargement des journaux...</div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" id="clearLogsBtn">Effacer les journaux</button>
                        <button class="btn btn-primary" id="exportLogsBtn">Exporter les journaux</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ VOS CL√âS FIREBASE - D√âJ√Ä CONFIGUR√âES ‚úÖ
        const firebaseConfig = {
            apiKey: "AIzaSyBj4YhiILIzeVwdHRhNKJfV-F_nV4_rOZU",
            authDomain: "msn-messenger-chat-eb36d.firebaseapp.com",
            databaseURL: "https://msn-messenger-chat-eb36d-default-rtdb.firebaseio.com",
            projectId: "msn-messenger-chat-eb36d",
            storageBucket: "msn-messenger-chat-eb36d.firebasestorage.app",
            messagingSenderId: "964598370839",
            appId: "1:964598370839:web:bb17248854ea42f7df4252"
        };

        // Initialisation Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            document.getElementById('firebaseStatus').textContent = '‚úÖ Firebase connect√©!';
            document.getElementById('firebaseStatus').style.color = 'green';
        } catch (error) {
            document.getElementById('firebaseStatus').textContent = '‚ùå Erreur Firebase: ' + error.message;
            document.getElementById('firebaseStatus').style.color = 'red';
        }

        // Comptes administrateurs
        const ADMIN_ACCOUNTS = {
            'admin': 'admin123',
            'moderator': 'mod123',
            'root': 'root123'
        };

        let currentAdmin = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);

            // Connexion admin
            document.getElementById('loginBtn').addEventListener('click', loginAdmin);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginAdmin();
            });

            // Boutons admin
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('logoutBtn').addEventListener('click', logoutAdmin);
            document.getElementById('kickAllBtn').addEventListener('click', kickAllUsers);
            document.getElementById('broadcastBtn').addEventListener('click', sendBroadcast);
            document.getElementById('clearChatBtn').addEventListener('click', clearAllChats);
            document.getElementById('resetSystemBtn').addEventListener('click', resetSystem);
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
            document.getElementById('searchUserBtn').addEventListener('click', searchUsers);

            // √âcouteurs en temps r√©el Firebase
            setupFirebaseListeners();
        });

        function setupFirebaseListeners() {
            if (!db) return;

            // √âcouter les utilisateurs connect√©s
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                updateConnectedUsers(users);
            });

            // √âcouter les messages
            db.ref('messages').on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                updateMessageStats(messages);
            });

            // √âcouter les logs
            db.ref('admin/logs').on('value', (snapshot) => {
                const logs = snapshot.val() || {};
                updateActivityLogs(logs);
            });

            // √âcouter les broadcasts
            db.ref('broadcasts').on('value', (snapshot) => {
                const broadcasts = snapshot.val() || {};
                updateBroadcastStats(broadcasts);
            });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        function loginAdmin() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (ADMIN_ACCOUNTS[username] && ADMIN_ACCOUNTS[username] === password) {
                currentAdmin = username;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                
                addLog(`Administrateur ${username} connect√©`);
                refreshData();
            } else {
                document.getElementById('errorMessage').textContent = 'Identifiants administrateur invalides';
            }
        }

        function logoutAdmin() {
            if (confirm('D√©connecter du panneau admin ?')) {
                currentAdmin = null;
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('errorMessage').textContent = '';
                document.getElementById('passwordInput').value = '';
            }
        }

        function refreshData() {
            addLog('Donn√©es rafra√Æchies manuellement');
        }

        function updateConnectedUsers(users) {
            const container = document.getElementById('connectedUsers');
            if (!container) return;

            const onlineUsers = Object.values(users).filter(user => user.status === 'online');
            
            container.innerHTML = '';
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div class="user-item">Aucun utilisateur connect√©</div>';
            } else {
                onlineUsers.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.innerHTML = `
                        <span>${user.username} <span style="color: #666;">(${user.status})</span></span>
                        <button class="btn btn-danger" onclick="kickUser('${user.id}')">Expulser</button>
                    `;
                    container.appendChild(userElement);
                });
            }
            
            document.getElementById('onlineCount').textContent = onlineUsers.length;
            document.getElementById('totalUsers').textContent = Object.keys(users).length;
        }

        function updateMessageStats(messages) {
            const today = new Date().toDateString();
            const todayMessages = Object.values(messages).filter(msg => {
                const msgDate = new Date(msg.timestamp).toDateString();
                return msgDate === today;
            }).length;

            document.getElementById('messagesToday').textContent = todayMessages;
            document.getElementById('activeChats').textContent = Math.floor(Object.keys(messages).length / 10);
        }

        function updateBroadcastStats(broadcasts) {
            // Mettre √† jour les stats des broadcasts si n√©cessaire
        }

        function updateActivityLogs(logs) {
            const container = document.getElementById('activityLogs');
            if (!container) return;

            container.innerHTML = '';
            const sortedLogs = Object.values(logs).sort((a, b) => b.timestamp - a.timestamp).slice(0, 10);

            if (sortedLogs.length === 0) {
                container.innerHTML = '<div class="user-item">Aucun journal disponible</div>';
            } else {
                sortedLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'user-item';
                    const time = new Date(log.timestamp).toLocaleTimeString('fr-FR');
                    logElement.innerHTML = `<span>${log.message}</span><span>${time}</span>`;
                    container.appendChild(logElement);
                });
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchUserInput').value.toLowerCase();
            if (!searchTerm) return;

            db.ref('users').once('value').then(snapshot => {
                const users = snapshot.val() || {};
                const filteredUsers = Object.values(users).filter(user => 
                    user.username && user.username.toLowerCase().includes(searchTerm)
                );

                const container = document.getElementById('allUsers');
                container.innerHTML = '';

                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div class="user-item">Aucun utilisateur trouv√©</div>';
                } else {
                    filteredUsers.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        userElement.innerHTML = `
                            <span>${user.username} <span style="color: #666;">(${user.status})</span></span>
                            <button class="btn btn-danger" onclick="banUser('${user.id}')">Bannir</button>
                        `;
                        container.appendChild(userElement);
                    });
                }
            });
        }

        function kickUser(userId) {
            db.ref('users/' + userId).update({
                status: 'kicked',
                kickedBy: currentAdmin,
                kickedAt: Date.now()
            }).then(() => {
                addLog(`Utilisateur ${userId} expuls√©`);
            });
        }

        function banUser(userId) {
            if (confirm('Bannir d√©finitivement cet utilisateur ?')) {
                db.ref('banned_users/' + userId).set({
                    bannedBy: currentAdmin,
                    bannedAt: Date.now(),
                    reason: 'Banni par administrateur'
                }).then(() => {
                    addLog(`Utilisateur ${userId} banni`);
                });
            }
        }

        function kickAllUsers() {
            if (confirm('D√©connecter tous les utilisateurs ?')) {
                db.ref('users').once('value').then(snapshot => {
                    const users = snapshot.val() || {};
                    const updates = {};
                    
                    Object.keys(users).forEach(userId => {
                        updates[`users/${userId}/status`] = 'offline';
                        updates[`users/${userId}/lastSeen`] = Date.now();
                    });

                    db.ref().update(updates).then(() => {
                        addLog('Tous les utilisateurs ont √©t√© d√©connect√©s');
                    });
                });
            }
        }

        function sendBroadcast() {
            const message = document.getElementById('broadcastInput').value.trim();
            if (message && db) {
                const broadcastData = {
                    message: message,
                    from: currentAdmin,
                    timestamp: Date.now(),
                    type: 'broadcast'
                };

                db.ref('broadcasts').push(broadcastData).then(() => {
                    addLog(`BROADCAST: ${message}`);
                    document.getElementById('broadcastInput').value = '';
                    alert('Message de broadcast envoy√© √† tous les utilisateurs');
                });
            }
        }

        function clearAllChats() {
            if (confirm('Vider tous les messages de chat ?')) {
                db.ref('messages').remove().then(() => {
                    addLog('Tous les chats ont √©t√© vid√©s');
                    alert('Tous les messages ont √©t√© supprim√©s');
                });
            }
        }

        function resetSystem() {
            if (confirm('R√©initialiser compl√®tement le syst√®me ? Cette action est irr√©versible!')) {
                const resetData = {
                    resetBy: currentAdmin,
                    resetAt: Date.now()
                };

                db.ref('system/resets').push(resetData);
                addLog('Syst√®me r√©initialis√© par administrateur');
                alert('Syst√®me r√©initialis√©');
            }
        }

        function clearLogs() {
            if (confirm('Effacer tous les journaux ?')) {
                db.ref('admin/logs').remove().then(() => {
                    addLog('Journaux effac√©s');
                });
            }
        }

        function exportLogs() {
            db.ref('admin/logs').once('value').then(snapshot => {
                const logs = snapshot.val() || {};
                const logsText = Object.values(logs)
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .map(log => `${new Date(log.timestamp).toLocaleString()} - ${log.message}`)
                    .join('\n');

                const blob = new Blob([logsText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `msn_admin_logs_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                addLog('Journaux export√©s');
            });
        }

        function addLog(message) {
            if (!db) return;

            const logData = {
                message: message,
                admin: currentAdmin,
                timestamp: Date.now()
            };

            db.ref('admin/logs').push(logData);
        }

        // Fonctions globales
        window.kickUser = kickUser;
        window.banUser = banUser;

        // V√©rification de la connexion Firebase
        setInterval(() => {
            const dbStatus = document.getElementById('dbStatus');
            if (db && dbStatus) {
                dbStatus.textContent = 'Base de donn√©es connect√©e';
                dbStatus.className = 'db-status db-online';
            } else {
                dbStatus.textContent = 'Base de donn√©es d√©connect√©e';
                dbStatus.className = 'db-status db-offline';
            }
        }, 5000);
    </script>
</body>
</html>